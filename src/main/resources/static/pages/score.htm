<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Score</title>
    <style>
        table {
            border: 1px solid black;
            border-collapse: collapse;
            background-color: hsl(0, 0%, 100%);
            display: inline-block;
        }

        td,
        th {
            border: 1px black solid;
            padding: 10px 25px
        }

        table th {
            background-color: lightgray;
        }

        form {
            border: 1px solid rgb(0, 0, 0);
            padding: 0px 10px 10px;
            margin: 10px;
            display: inline-block;
            vertical-align: top;
        }
    </style>
</head>

<body>
    <h1>Score</h1>
    <p>
        <a href="/index.htm">Home Page</a>
    </p>

    <h4>分页查询</h4>
    <p>
        limit: <input id="limit" type="number" />
        offset: <input id="offset" type="number" />
        <button onclick="sendRequest()">获取</button>
    </p>

    <h4>按id查询</h4>
    请输入需要查找的id: <input id="id" type="number" />
    <button onclick="sendSelect()">查询</button>
    
    <p>
        <h4>插入数据</h4>
    </p>
    <p>
        学生学号: <input id="studentId" type="number" />
        <br>
        语文成绩: <input id="chinese" type="number" />

        <br>
        数学成绩: <input id="math" type="number" />

        <br>
        英语成绩: <input id="english" type="number" />
        <br>
        <button onclick="handleSubmit()">确认插入</button>
        <input type="reset" value="重置" />
    </p>

    <form name="scoreform2" onsubmit="return false;">
        <h2>更新</h2>
        <p>
            Id:
            <input name="id" readonly="true" />
        </p>
        <p>
            学生ID:
            <input name="studentId" />
        </p>
        <p>
            语文成绩: 
            <input name="chinese" type="number" />
        </p>
        <p>
            数学成绩: 
            <input name="math" type="number" />
        </p>
        <p>
            英语成绩: 
            <input name="english" type="number" />
        </p>
       

        <input type="button" value="提交" onclick="handleUpdate()" />
        <input type="reset" value="重置" />
    </form>
    <table>
        <thead>
            <tr>
                <th>Id</th>
                <th>学生学号</th>
                <th>语文成绩</th>
                <th>数学成绩</th>
                <th>英语成绩</th>
                <th>操作</th>

            </tr>
        </thead>
        <tbody id="table">
        </tbody>
    </table>

    <script>
        const table = document.getElementById('table')
        const limitInput = document.getElementById('limit')
        const offsetInput = document.getElementById('offset')
        const idInput = document.getElementById('id')
        const studentIdInput = document.getElementById('studentId')
        const chineseInput = document.getElementById('chinese')
        const mathInput = document.getElementById('math')
        const englishInput = document.getElementById('english')
        const form2 = document.forms.scoreform2

        function addRow(record) {
            let recordHtml = ''
            recordHtml += '<tr>'
            recordHtml += '<td>' + record.id + '</td>'
            recordHtml += '<td>' + record.studentId + '</td>'
            recordHtml += '<td>' + record.chinese + '</td>'
            recordHtml += '<td>' + record.math + '</td>'
            recordHtml += '<td>' + record.english + '</td>'
            recordHtml += '<td>'
            recordHtml += '  <button onclick="handleDelete(' + record.id + ')">删除</button>'
            recordHtml += '  <button onclick="clickUpdate(' + record.id + ', ' + record.studentId + ', ' + record.chinese + ', ' + record.math + ' ,' + record.english + ')">更新</button>'
            recordHtml += '</td>'
            recordHtml += '</tr>'
            table.innerHTML += recordHtml
        }

        async function getScore(limit, offset) {
            const url = 'http://localhost:8080/score/list?limit=' + limit + '&offset=' + offset
            console.log('请求地址：', url)
            const data = await fetch(url).then(function getRequestFromAPI(response) {
                return response.json()
            })
            return data
        }
        async function sendRequest() {
            const limit = limitInput.value
            const offset = offsetInput.value
            const data = await getScore(limit, offset)
            console.log('请求返回值：', data)

            table.innerHTML = ''
            for (let i = 0; i < data.length; i++) {
                addRow(data[i])
            }
        }
        sendRequest()

        async function getById(id) {
            const url = 'http://localhost:8080/score/' + id
            console.log('请求地址：', url)
            if (!id || !id.trim()) {
                alert("id没有输入，无法提交")
                return
            } else {
                id = id.trim()
            }
            const data = await fetch(url).then(function getRequestFromAPI(response) {
                return response.json()
            })
            return data
        }

        async function sendSelect() {
            const id = idInput.value
            const data = await getById(id)
            console.log('请求返回值：', data)

            table.innerHTML = ''
            addRow(data)

        }

        async function insertScore(studentId, chinese, math, english) {
            const url = 'http://localhost:8080/score'
            console.log('请求地址：', url)
            console.log('请求载荷：', studentId, chinese, math, english)

            const data = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "studentId": studentId,
                    "chinese": chinese,
                    "math": math,
                    "english": english
                })}).then(function getRequestFromAPI(response) {
                return response.json()
            })
            return data
}

        async function handleSubmit() {
            console.log('点击了提交按钮')
            const studentId = studentIdInput.value
            const chinese = chineseInput.value
            const math = mathInput.value
            const english = englishInput.valueconst 
            requestData = Object.fromEntries(formData)
            const data = await insertScore(studentId, chinese, math, english)
            console.log('插入数据', data)
            if (!studentId || !studentId.trim()) {
                alert("学生ID没有输入，无法提交")
                return
            } else {
                studentId = studentId.trim()
            }
            if (!chinese || !chinese.trim()) {
                alert("语文成绩没有输入，无法提交")
                return
            } else {
                chinese = chinese.trim()
            }
            if (!math || !math.trim()) {
                alert("数学成绩没有输入，无法提交")
                return
            } else {
                math = math.trim()
            }
            if (!english || !english.trim()) {
                alert("英语成绩没有输入，无法提交")
                return
            } else {
                english = english.trim()
            }
            table.innerHTML = ''
            addRow(data)
        }

        async function deleteStudent(id) {
            const url = 'http://localhost:8080/score/' + id
            console.log('请求地址：', url)

            const data = await fetch(url, {
                method: 'DELETE',
            }).then(function getRequestFromAPI(response) {
                return response.json()
            })
            return data
        }

        async function handleDelete(id) {
            console.log('点击了删除按钮, id:', id)
            await deleteStudent(id)
            await sendRequest()
        }

        function clickUpdate(id, studentId, chinese, math, english) {
            form2.id.value = id
            form2.studentId.value = studentId
            form2.chinese.value = chinese
            form2.math.value = math
            form2.english.value = english
            console.log('更新数据：', { id, studentId, chinese, math, english })
        }

        async function updateStudent(id, body) {
            const url = 'http://localhost:8080/score/' + id
            console.log('请求地址：', url)
            console.log('请求载荷：', body)

            const data = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            }).then(function getRequestFromAPI(response) {
                return response.json()
            })
            return data
        }

        async function handleUpdate() {
            console.log('点击了提交按钮')
            const formData = new FormData(form2)
            const requestData = Object.fromEntries(formData)
            console.log('表单输入数据：', requestData)

            if (!requestData.studentId || !requestData.studentId.trim()) {
                alert("学生ID没有输入，无法提交")
                return
            } else {
                requestData.studentId = requestData.studentId.trim()
            }
            if (!requestData.chinese || !requestData.chinese.trim()) {
                alert("语文成绩没有输入，无法提交")
                return
            } else {
                requestData.chinese = requestData.chinese.trim()
            }
            if (!requestData.math || !requestData.math.trim()) {
                alert("数学成绩没有输入，无法提交")
                return
            } else {
                requestData.math = requestData.math.trim()
            }
            if (!requestData.english || !requestData.english.trim()) {
                alert("英语成绩没有输入，无法提交")
                return
            } else {
                requestData.english = requestData.english.trim()
            }
            const responseData = await updateStudent(requestData.id, {
                studentId: requestData.studentId,
                chinese: requestData.chinese,
                math: requestData.math,
                english: requestData.english,
            })
            console.log('请求返回值：', responseData)
            table.innerHTML = ''
            addRow(responseData)

            form2.reset()
        }
    </script>
</body>

</html>